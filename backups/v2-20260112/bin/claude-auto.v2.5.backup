#!/bin/bash
# Claude Code Enhanced Launcher - FAST START Edition
# Version: 2.5
# Last Updated: January 2, 2026
#
# This script:
# 1. Sets working directory
# 2. Starts Claude Code IMMEDIATELY
# 3. Runs all checks in background
# 4. Writes status to log file for review

set -e

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

# Source helper functions
source "$LIB_DIR/helpers.sh"

# Configuration
CCODE_DIR="${CLAUDE_CODE_DIR:-$HOME/Dropbox/ALOMA/claude-code}"
BEST_PRACTICES="$CCODE_DIR/CLAUDE_CODE_UNIVERSAL_BEST_PRACTICES.md"
BACKGROUND_LOG="/tmp/claude-auto-background.log"

# Fast banner
fast_banner() {
    echo "╔══════════════════════════════════════════════════════════╗"
    echo "║        Claude Code Enhanced Launcher v2.5 (Fast)         ║"
    echo "╚══════════════════════════════════════════════════════════╝"
}

# Background checks function - outputs to screen via tee (with delay)
run_background_checks() {
    local log="$BACKGROUND_LOG"

    # Delay to let Claude Code start first, then output to screen
    sleep 2

    # Use tee to write to BOTH log file AND screen (stderr so it shows during Claude Code)
    {
        echo ""
        echo "┌──────────────────────────────────────────────────────────┐"
        echo "│  BACKGROUND CHECKS                                       │"
        echo "└──────────────────────────────────────────────────────────┘"

        # Quick service status (most important)
        echo ""
        echo "Services:"
        for port in 8001 5173 3001 3000; do
            case $port in
                8001) name="Backend API" ;;
                5173) name="LLM Council" ;;
                3001) name="Workflow Gen" ;;
                3000) name="Workflow Auto" ;;
            esac
            if lsof -i ":$port" -sTCP:LISTEN > /dev/null 2>&1; then
                echo "  ✓ $name (port $port)"
            else
                echo "  ✗ $name (port $port) - NOT RUNNING"
            fi
        done

        # Git status (brief)
        echo ""
        echo "Git:"
        cd "$CCODE_DIR"
        for repo in claude-auto-launcher llm-council weekly-ai-sigint workflow-automation vibe-coding-utilities; do
            if [ -d "$repo/.git" ]; then
                cd "$repo"
                local status=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
                local unpushed=$(git log @{u}.. --oneline 2>/dev/null | wc -l | tr -d ' ')
                if [ "$status" -gt 0 ] || [ "$unpushed" -gt 0 ]; then
                    echo "  ⚠️  $repo: $status uncommitted, $unpushed unpushed"
                else
                    echo "  ✓ $repo"
                fi
                cd "$CCODE_DIR"
            fi
        done

        # Security scan (can be slow, show last)
        echo ""
        echo "Security scan..."
        cd "$CCODE_DIR"
        local scan_result=$(check_sensitive_data "$CCODE_DIR" 2>&1)
        if echo "$scan_result" | grep -q "SENSITIVE DATA DETECTED"; then
            echo "  ⚠️  Sensitive data warnings - review before committing"
        else
            echo "  ✓ No sensitive data in staged files"
        fi

        echo ""
        echo "────────────────────────────────────────────────────────────"

    } 2>&1 | tee -a "$log" >&2
}

# Start services function (background) - outputs to screen via tee (with delay)
start_services_background() {
    local log="$BACKGROUND_LOG"

    # Delay to let Claude Code start first, then output to screen
    sleep 1

    {
        echo ""
        echo "Starting services in background..."

        cd "$CCODE_DIR"

        # Backend API (port 8001)
        if ! lsof -i :8001 -sTCP:LISTEN > /dev/null 2>&1; then
            cd "$CCODE_DIR/llm-council"
            if [ -d ".venv" ]; then
                source .venv/bin/activate
                python -m backend.main > /tmp/llm-council-backend.log 2>&1 &
            else
                uv run python -m backend.main > /tmp/llm-council-backend.log 2>&1 &
            fi
            echo "  → Backend API starting..."
        fi

        # Frontend (port 5173)
        if ! lsof -i :5173 -sTCP:LISTEN > /dev/null 2>&1; then
            cd "$CCODE_DIR/llm-council/frontend"
            npm run dev > /tmp/llm-council-frontend.log 2>&1 &
            echo "  → LLM Council Frontend starting..."
        fi

        # Workflow Generator (port 3001)
        if ! lsof -i :3001 -sTCP:LISTEN > /dev/null 2>&1; then
            cd "$CCODE_DIR/vibe-coding-utilities/workflow-generator"
            PORT=3001 npm start > /tmp/workflow-generator.log 2>&1 &
            echo "  → Workflow Generator starting..."
        fi

        # Workflow Automation (port 3000)
        if ! lsof -i :3000 -sTCP:LISTEN > /dev/null 2>&1; then
            cd "$CCODE_DIR/workflow-automation"
            pnpm dev > /tmp/workflow-automation.log 2>&1 &
            echo "  → Workflow Automation starting..."
        fi

    } 2>&1 | tee -a "$log" >&2
}

main() {
    fast_banner

    # Change to claude-code directory
    cd "$CCODE_DIR" || {
        echo "Error: Cannot access $CCODE_DIR"
        exit 1
    }
    echo ""
    echo "✓ Directory: $(pwd)"
    echo "✓ Best Practices: $BEST_PRACTICES"

    # Start background checks and services (will appear on screen after delay)
    run_background_checks &
    start_services_background &

    echo ""
    echo "Starting Claude Code..."
    echo "(Background checks will appear below after startup)"
    echo ""

    # Start Claude Code immediately (no delay)
    claude --dangerously-skip-permissions
}

main "$@"
