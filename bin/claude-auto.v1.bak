#!/bin/bash
# claude-auto v3.4 - Config-driven Claude Code launcher
# v3.4: Correct permission format (no parentheses for allow-all)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/helpers.sh" 2>/dev/null || true

STARTUP_LOG="/tmp/claude-auto-startup.log"

print_banner() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  claude-auto v3.4 - Config-Driven Claude Code Launcher       â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

ensure_claude_permissions() {
    local settings_dir="$CLAUDE_AUTO_WORKDIR/.claude"
    local settings_file="$settings_dir/settings.json"
    mkdir -p "$settings_dir"
    if [[ -f "$settings_file" ]] && grep -q '"Bash"' "$settings_file" 2>/dev/null && ! grep -q '"Bash(\*)"' "$settings_file" 2>/dev/null; then
        echo "âœ… .claude/settings.json already configured" >> "$STARTUP_LOG"
        return
    fi
    cat > "$settings_file" << 'EOF'
{
  "permissions": {
    "allow": [
      "Bash",
      "Read",
      "Write",
      "Edit",
      "mcp__desktop-commander"
    ]
  }
}
EOF
    echo "âœ… .claude/settings.json created with permissions" >> "$STARTUP_LOG"
}

start_services_if_configured() {
    [[ ${#CLAUDE_AUTO_SERVICES[@]} -eq 0 ]] && return
    echo "=== Service Status ===" >> "$STARTUP_LOG"
    for service_def in "${CLAUDE_AUTO_SERVICES[@]}"; do
        IFS=':' read -r name port start_cmd health_path <<< "$service_def"
        if lsof -i :"$port" >/dev/null 2>&1; then
            echo "âœ… $name (port $port) - running" >> "$STARTUP_LOG"
        else
            echo "ðŸ”„ Starting $name on port $port..." >> "$STARTUP_LOG"
            (cd "$CLAUDE_AUTO_WORKDIR" && eval "$start_cmd" >> "$STARTUP_LOG" 2>&1 &)
        fi
    done
}

open_browser_tabs() {
    [[ ${#CLAUDE_AUTO_BROWSER_URLS[@]} -eq 0 ]] && return
    for url in "${CLAUDE_AUTO_BROWSER_URLS[@]}"; do open "$url" 2>/dev/null || true; done
}

quick_git_status() {
    echo "=== Quick Git Status ===" >> "$STARTUP_LOG"
    for repo in $CLAUDE_AUTO_REPOS; do
        [[ -d "$CLAUDE_AUTO_WORKDIR/$repo/.git" ]] || continue
        cd "$CLAUDE_AUTO_WORKDIR/$repo"
        changes=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
        unpushed=$(git log --oneline @{u}..HEAD 2>/dev/null | wc -l | tr -d ' ')
        [[ "$changes" -gt 0 || "$unpushed" -gt 0 ]] && echo "âš ï¸  $repo: $changes uncommitted, $unpushed unpushed" >> "$STARTUP_LOG"
    done
    cd "$CLAUDE_AUTO_WORKDIR"
}

main() {
    print_banner
    load_config
    echo "=== claude-auto startup $(date) ===" > "$STARTUP_LOG"
    cd "$CLAUDE_AUTO_WORKDIR"
    echo "ðŸ“‚ Working directory: $CLAUDE_AUTO_WORKDIR"
    echo "ðŸ“‹ Status: tail -f $STARTUP_LOG"
    echo ""
    ensure_claude_permissions
    (sleep 1; start_services_if_configured) &
    (sleep 2; quick_git_status) &
    (sleep 5; open_browser_tabs) &
    echo "ðŸš€ Launching Claude Code..."
    exec claude
}

main "$@"
