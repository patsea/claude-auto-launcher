#!/bin/bash
# README Auto-Updater
# Version: 1.0
# Last Updated: January 17, 2026
# Updates README.md files with daily changes summary

set -e

CLAUDE_CODE_DIR="${1:-$HOME/Dropbox/ALOMA/claude-code}"
TODAY=$(date +%Y-%m-%d)
MARKER_START="<!-- AUTO-GENERATED: Recent Changes -->"
MARKER_END="<!-- END AUTO-GENERATED -->"

log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

# Get list of projects (directories with .git)
get_projects() {
    find "$CLAUDE_CODE_DIR" -maxdepth 2 -name ".git" -type d 2>/dev/null | \
        xargs -I {} dirname {} | \
        grep -v node_modules | \
        sort -u
}

# Get today's changes for a project
get_daily_changes() {
    local project_dir="$1"
    local project_name=$(basename "$project_dir")

    cd "$project_dir" || return 1

    # Get files modified today (tracked by git)
    local changed_files=$(git diff --name-only HEAD~1 2>/dev/null || git diff --name-only 2>/dev/null || echo "")
    local today_commits=$(git log --since="$TODAY 00:00:00" --oneline 2>/dev/null || echo "")

    # Count changes
    local file_count=$(echo "$changed_files" | grep -v "^$" | wc -l | tr -d ' ')
    local commit_count=$(echo "$today_commits" | grep -v "^$" | wc -l | tr -d ' ')

    if [[ "$file_count" -eq 0 && "$commit_count" -eq 0 ]]; then
        echo ""
        return 0
    fi

    # Generate summary
    echo "### Recent Activity"
    echo ""
    echo "**Last Updated**: $TODAY"
    echo ""

    if [[ "$commit_count" -gt 0 ]]; then
        echo "**Today's Commits** ($commit_count):"
        echo ""
        echo "$today_commits" | head -5 | while read -r line; do
            echo "- $line"
        done
        if [[ "$commit_count" -gt 5 ]]; then
            echo "- ... and $((commit_count - 5)) more"
        fi
        echo ""
    fi

    if [[ "$file_count" -gt 0 ]]; then
        echo "**Files Changed** ($file_count):"
        echo ""
        # Group by directory
        echo "$changed_files" | grep -v "^$" | cut -d'/' -f1 | sort | uniq -c | sort -rn | head -5 | while read -r count dir; do
            echo "- \`$dir/\`: $count files"
        done
        echo ""
    fi
}

# Update README with changes section
update_readme() {
    local project_dir="$1"
    local readme="$project_dir/README.md"
    local project_name=$(basename "$project_dir")

    # Skip if no README
    if [[ ! -f "$readme" ]]; then
        log "  ⚠️  $project_name: No README.md found"
        return 0
    fi

    # Get changes
    local changes=$(get_daily_changes "$project_dir")

    if [[ -z "$changes" ]]; then
        log "  ○ $project_name: No changes today"
        return 0
    fi

    # Create new content block
    local new_block="$MARKER_START
$changes
$MARKER_END"

    # Check if markers exist
    if grep -q "$MARKER_START" "$readme"; then
        # Replace existing block
        # Use awk for multi-line replacement
        awk -v start="$MARKER_START" -v end="$MARKER_END" -v new="$new_block" '
            $0 ~ start { skip=1; print new; next }
            $0 ~ end { skip=0; next }
            !skip { print }
        ' "$readme" > "$readme.tmp"
        mv "$readme.tmp" "$readme"
        log "  ✓ $project_name: Updated existing changes section"
    else
        # Append block before first ## heading (or at end)
        if grep -q "^## " "$readme"; then
            # Insert before first ## heading
            awk -v block="$new_block" '
                !inserted && /^## / { print block; print ""; inserted=1 }
                { print }
                END { if (!inserted) { print ""; print block } }
            ' "$readme" > "$readme.tmp"
            mv "$readme.tmp" "$readme"
        else
            # Append at end
            echo "" >> "$readme"
            echo "$new_block" >> "$readme"
        fi
        log "  ✓ $project_name: Added changes section"
    fi
}

# Main
main() {
    log "README Auto-Updater starting..."
    log "Scanning: $CLAUDE_CODE_DIR"
    echo ""

    local updated=0
    local skipped=0

    for project in $(get_projects); do
        update_readme "$project"
        if [[ $? -eq 0 ]]; then
            ((updated++)) || true
        else
            ((skipped++)) || true
        fi
    done

    echo ""
    log "Complete: $updated projects processed"
}

main "$@"
